<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Inventario Costeado â€“ PROVSOFT</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --azul:#00416A; --accent:#0c6cbd; --card:#fff; --muted:#64748b;
      --grad: linear-gradient(to right,#00416A,#E4E5E6);
      --radius:14px; --shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Poppins',sans-serif; background:var(--grad); color:#0f172a;
      min-height:100vh; padding:18px;
    }
    header{ color:#fff; text-align:center; margin-bottom:12px }
    header h1{ margin:0 0 4px 0; line-height:1.1 }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin:0 auto; max-width:1200px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    select,button{
      font-family:inherit; font-size:15px; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff;
    }
    label{ font-size:13px; color:#0c2a5e; font-weight:600 }
    .chip{ background:#e8edf6; color:#0c2a5e; border-radius:999px; padding:6px 10px; font-weight:700 }
    .btn{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
    .btn:active{ filter:brightness(.92) }
    .btn-ghost{ background:#eef2f7; color:#0c2a5e; border:1px solid #d9e1ee }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .kpi{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:160px }
    .kpi .v{ font-size:20px; font-weight:800 }
    .tablewrap{ margin-top:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:auto }
    table{ width:100%; border-collapse:collapse; min-width:880px }
    th,td{ padding:10px; border-bottom:1px solid #eef2f7; text-align:center }
    th{ position:sticky; top:0; background:#00416A; color:#fff; z-index:1 }
    td.l{ text-align:left }
    .muted{ color:#64748b }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px }
    .right{ margin-left:auto }
  </style>
</head>
<body>
  <header>
    <h1>INVENTARIO COSTEADO (sin IVA)</h1>
    <div class="muted">Por <b>sucursal</b> y <b>usuario</b> â€¢ PROVSOFT</div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label for="sucursal">Sucursal</label><br/>
        <select id="sucursal">
          <option value="">-- Selecciona sucursal --</option>
          <option>Matriz</option><option>Provileon</option><option>Central</option><option>Osito</option>
          <option>Bodega Principal</option><option>Bodega Abarrotes</option><option>Bodega Dulces</option>
          <option>Zapata</option><option>Allende</option><option>Allende 2</option><option>Rio Verde</option>
          <option>Montemorelos</option><option>Bodega 41</option>
        </select>
      </div>
      <div>
        <label for="usuario">Usuario (opcional)</label><br/>
        <select id="usuario">
          <option value="">â€” Todos â€”</option>
          <option>Blanca</option><option>Lizandro</option><option>Edgardo</option><option>Fernanda</option>
          <option>Esmeralda</option><option>Gibran</option><option>Roberto</option><option>Caleb</option><option>Prueba</option>
          <option>Usuario 1</option><option>Usuario 2</option><option>Usuario 3</option><option>Usuario 4</option>
        </select>
      </div>

      <div class="right">
        <button id="btnCargar" class="btn">ðŸ”„ Cargar</button>
        <button id="btnExportar" class="btn-ghost">â¬‡ Exportar Excel</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="l muted">Partidas</div><div class="v" id="kPartidas">0</div></div>
      <div class="kpi"><div class="l muted">ArtÃ­culos Ãºnicos</div><div class="v" id="kUnicos">0</div></div>
      <div class="kpi"><div class="l muted">Cantidad total</div><div class="v" id="kCantidad">0.000</div></div>
      <div class="kpi"><div class="l muted">Valor inventario</div><div class="v" id="kValor">$0.00</div></div>
      <div class="kpi"><div class="l muted">Sucursal</div><div class="v" id="kSucursal">â€”</div></div>
      <div class="kpi"><div class="l muted">Usuario</div><div class="v" id="kUsuario">Todos</div></div>
    </div>

    <div class="toolbar">
      <span class="chip" id="estado">Listo</span>
    </div>

    <div class="tablewrap">
      <table id="tabla">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, documentId
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const USUARIOS = ["Blanca","Lizandro","Edgardo","Fernanda","Esmeralda","Gibran","Roberto","Caleb","Prueba","Usuario 1","Usuario 2","Usuario 3","Usuario 4"];

    const $ = (id)=>document.getElementById(id);
    const fmtDec = (n,d=3)=>Number(n||0).toFixed(d);
    const fmtMoney = (n)=> n.toLocaleString('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2});

    const selSucursal=$("sucursal"), selUsuario=$("usuario");
    const btnCargar=$("btnCargar"), btnExportar=$("btnExportar"), estado=$("estado");
    const thead=$("thead"), tbody=$("tbody");
    const kPartidas=$("kPartidas"), kUnicos=$("kUnicos"), kCantidad=$("kCantidad"), kValor=$("kValor");
    const kSucursal=$("kSucursal"), kUsuario=$("kUsuario");

    let datosAgrupa=[], ultimaDescarga=[];
    let costCache=new Map();

    function setEstado(m){ estado.textContent=m; }
    function limpiarTabla(){ thead.innerHTML=""; tbody.innerHTML=""; }

    function agruparPorProducto(rows){
      const map=new Map();
      for(const r of rows){
        const k=r.codigo||"";
        if(!map.has(k)){
          map.set(k,{codigo:k, descripcion:r.descripcion||"SIN DESC", cantidad:Number(r.cantidad||0)});
        }else{
          const it=map.get(k);
          it.cantidad+=Number(r.cantidad||0);
        }
      }
      return Array.from(map.values());
    }

    async function cargarCostos(codigos){
      const falt=codigos.filter(c=>!costCache.has(c));
      if(!falt.length) return;
      for(let i=0;i<falt.length;i+=10){
        const batch=falt.slice(i,i+10);
        const q=query(collection(db,"productos"), where(documentId(),'in',batch));
        const snap=await getDocs(q);
        snap.forEach(d=>{
          const c=Number(d.data().costoSinImpuesto??0);
          costCache.set(d.id,isFinite(c)?c:0);
        });
        batch.forEach(id=>{ if(!costCache.has(id)) costCache.set(id,0); });
      }
    }

    function renderCosteado(rows){
      thead.innerHTML=`
        <tr><th>#</th><th>CÃ³digo</th><th>DescripciÃ³n</th>
        <th>Cantidad</th><th>Costo Unit.</th><th>Total (sin IVA)</th></tr>`;
      let total=0, sumaCant=0;
      tbody.innerHTML=rows.map((r,i)=>{
        const cu=Number(costCache.get(r.codigo)??0);
        const tt=cu*Number(r.cantidad||0);
        total+=tt; sumaCant+=Number(r.cantidad||0);
        return `<tr>
          <td>${i+1}</td><td class="l">${r.codigo}</td><td class="l">${r.descripcion}</td>
          <td>${fmtDec(r.cantidad,3)}</td><td>${fmtMoney(cu)}</td><td>${fmtMoney(tt)}</td>
        </tr>`;
      }).join("");
      kPartidas.textContent=rows.length;
      kUnicos.textContent=rows.length;
      kCantidad.textContent=fmtDec(sumaCant,3);
      kValor.textContent=fmtMoney(total);
      ultimaDescarga=rows.map(r=>({codigo:r.codigo, desc:r.descripcion, cantidad:r.cantidad, costo:costCache.get(r.codigo)||0, total:(costCache.get(r.codigo)||0)*r.cantidad}));
    }

    async function cargar(){
      const suc=selSucursal.value.trim(), usr=selUsuario.value.trim();
      if(!suc) return alert("Selecciona una sucursal");
      setEstado("Cargandoâ€¦");
      limpiarTabla(); kSucursal.textContent=suc; kUsuario.textContent=usr||"Todos";
      costCache=new Map();

      let rows=[];
      if(usr){
        const col=collection(db,"inventarios",suc,"usuarios",usr,"escaneos");
        const snap=await getDocs(col);
        snap.forEach(d=>{const r=d.data(); rows.push({codigo:r.codigo,descripcion:r.descripcion,cantidad:Number(r.cantidad||0)});});
      }else{
        const lotes=await Promise.all(USUARIOS.map(async u=>{
          const col=collection(db,"inventarios",suc,"usuarios",u,"escaneos");
          const snap=await getDocs(col); const arr=[];
          snap.forEach(d=>{const r=d.data(); arr.push({codigo:r.codigo,descripcion:r.descripcion,cantidad:Number(r.cantidad||0)});});
          return arr;
        }));
        rows=lotes.flat();
      }

      datosAgrupa=agruparPorProducto(rows);
      await cargarCostos(datosAgrupa.map(x=>x.codigo));
      renderCosteado(datosAgrupa);
      setEstado(rows.length?`Listo (${rows.length} partidas)`:"Sin resultados");
    }

    btnCargar.addEventListener("click",cargar);

    btnExportar.addEventListener("click",()=>{
      if(!ultimaDescarga.length) return alert("Nada que exportar");
      const data=[["#","CÃ³digo","DescripciÃ³n","Cantidad","Costo Unit.","Total"]];
      ultimaDescarga.forEach((r,i)=>data.push([i+1,r.codigo,r.desc,r.cantidad,r.costo,r.total]));
      const ws=XLSX.utils.aoa_to_sheet(data), wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Costeado");
      const suc=selSucursal.value||"Sucursal", usr=selUsuario.value||"Todos";
      XLSX.writeFile(wb,`InventarioCosteado_${suc}_${usr}_${new Date().toISOString().slice(0,10)}.xlsx`);
    });
  </script>
</body>
</html>
