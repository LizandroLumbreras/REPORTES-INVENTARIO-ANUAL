<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Visor â€“ Inventarios Escaneados</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --azul:#00416A; --accent:#0c6cbd; --card:#fff; --muted:#64748b;
      --grad: linear-gradient(to right,#00416A,#E4E5E6);
      --radius:14px; --shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Poppins',sans-serif; background:var(--grad); color:#0f172a;
      min-height:100vh; padding:18px;
    }
    header{ color:#fff; text-align:center; margin-bottom:12px }
    header h1{ margin:0 0 4px 0; line-height:1.1 }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin:0 auto; max-width:1200px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    select,button{
      font-family:inherit; font-size:15px; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff;
    }
    label{ font-size:13px; color:#0c2a5e; font-weight:600 }
    .chip{ background:#e8edf6; color:#0c2a5e; border-radius:999px; padding:6px 10px; font-weight:700 }
    .btn{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
    .btn:active{ filter:brightness(.92) }
    .btn-ghost{ background:#eef2f7; color:#0c2a5e; border:1px solid #d9e1ee }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .kpi{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:160px }
    .kpi .v{ font-size:20px; font-weight:800 }
    .tablewrap{ margin-top:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:auto }
    table{ width:100%; border-collapse:collapse; min-width:880px }
    th,td{ padding:10px; border-bottom:1px solid #eef2f7; text-align:center }
    th{ position:sticky; top:0; background:#00416A; color:#fff; z-index:1 }
    td.l{ text-align:left }
    .muted{ color:var(--muted) }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px }
    .right{ margin-left:auto }
  </style>
</head>
<body>
  <header>
    <h1>INVENTARIOS ANUALES â€“ VISOR</h1>
    <div class="muted">Consulta lo escaneado por <b>sucursal</b> y <b>usuario</b> â€¢ PROVSOFT</div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label for="sucursal">Sucursal</label><br/>
        <select id="sucursal">
          <option value="">-- Selecciona sucursal --</option>
          <option>Matriz</option><option>Provileon</option><option>Central</option><option>Osito</option>
          <option>Bodega Principal</option><option>Bodega Abarrotes</option><option>Bodega Dulces</option>
          <option>Zapata</option><option>Allende</option><option>Allende 2</option><option>Rio Verde</option>
          <option>Montemorelos</option><option>Bodega 41</option>
        </select>
      </div>
      <div>
        <label for="usuario">Usuario (opcional)</label><br/>
        <select id="usuario">
          <option value="">â€” Todos â€”</option>
          <option>Blanca</option><option>Lizandro</option><option>Edgardo</option><option>Fernanda</option>
          <option>Esmeralda</option><option>Gibran</option><option>Roberto</option><option>Caleb</option><option>Prueba</option>
          <option>Usuario 1</option><option>Usuario 2</option><option>Usuario 3</option><option>Usuario 4</option>
        </select>
      </div>

      <div>
        <label for="vista">Vista</label><br/>
        <select id="vista">
          <option value="agrupado">Agrupado por producto</option>
          <option value="crudo">Partidas (crudo)</option>
          <option value="costeado">Costeado (sin IVA)</option>
        </select>
      </div>

      <div class="right">
        <button id="btnCargar" class="btn">ðŸ”„ Cargar</button>
        <button id="btnExportar" class="btn-ghost">â¬‡ Exportar Excel</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="l muted">Partidas</div><div class="v" id="kPartidas">0</div></div>
      <div class="kpi"><div class="l muted">ArtÃ­culos Ãºnicos</div><div class="v" id="kUnicos">0</div></div>
      <div class="kpi"><div class="l muted">Cantidad total</div><div class="v" id="kCantidad">0.000</div></div>
      <div class="kpi"><div class="l muted">Valor inventario</div><div class="v" id="kValor">$0.00</div></div>
      <div class="kpi"><div class="l muted">Sucursal</div><div class="v" id="kSucursal">â€”</div></div>
      <div class="kpi"><div class="l muted">Usuario</div><div class="v" id="kUsuario">Todos</div></div>
    </div>

    <div class="toolbar">
      <span class="chip" id="estado">Listo</span>
    </div>

    <div class="tablewrap">
      <table id="tabla">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, documentId
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ====== CONFIG FIREBASE ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ====== LISTA DE USUARIOS PARA FAN-OUT ====== */
    const USUARIOS = ["Blanca","Lizandro","Edgardo","Fernanda","Esmeralda","Gibran","Roberto","Caleb","Prueba","Usuario 1","Usuario 2","Usuario 3","Usuario 4"];

    /* ====== UTIL ====== */
    const $ = (id)=>document.getElementById(id);
    const fmtDec = (n, d=3)=> Number(n||0).toFixed(d);
    const fmtMoney = (n)=> n.toLocaleString('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2});

    const selSucursal = $("sucursal");
    const selUsuario  = $("usuario");
    const selVista    = $("vista");
    const btnCargar   = $("btnCargar");
    const btnExportar = $("btnExportar");
    const estado      = $("estado");

    const thead = $("thead");
    const tbody = $("tbody");

    const kPartidas = $("kPartidas");
    const kUnicos   = $("kUnicos");
    const kCantidad = $("kCantidad");
    const kValor    = $("kValor");
    const kSucursal = $("kSucursal");
    const kUsuario  = $("kUsuario");

    let datosCrudos = [];     // filas crudas (escaneos)
    let datosAgrupa = [];     // filas agrupadas por producto
    let costCache   = new Map(); // codigo -> costoSinImpuesto (number)
    let ultimaDescarga = [];  // lo que estÃ¡ visible (para exportar)

    function setEstado(msg){ estado.textContent = msg; }
    function limpiarTabla(){ thead.innerHTML=""; tbody.innerHTML=""; }

    function kpisDesdeCrudo(rows){
      const partidas = rows.length;
      const unicos = new Set(rows.map(r=> r.codigo || "")).size;
      const sumaCant = rows.reduce((a,r)=> a + Number(r.cantidad || 0), 0);
      kPartidas.textContent = partidas;
      kUnicos.textContent   = unicos;
      kCantidad.textContent = fmtDec(sumaCant, 3);
      // valor (si tenemos costos cargados para los cÃ³digos presentes)
      const val = rows.reduce((acc,r)=>{
        const c = Number(costCache.get(r.codigo) ?? 0);
        return acc + (Number(r.cantidad||0) * c);
      }, 0);
      kValor.textContent = fmtMoney(val);
    }

    function agruparPorProducto(rows){
      const map = new Map();
      for(const r of rows){
        const key = r.codigo || "";
        if(!map.has(key)){
          map.set(key, {
            codigo: key,
            descripcion: r.descripcion || "SIN DESCRIPCIÃ“N",
            cantidad: Number(r.cantidad || 0),
            partidas: 1,
            ultimaFecha: r.fecha || ""
          });
        }else{
          const it = map.get(key);
          it.cantidad += Number(r.cantidad || 0);
          it.partidas += 1;
          if((r.fecha||"") > (it.ultimaFecha||"")) it.ultimaFecha = r.fecha || "";
        }
      }
      return Array.from(map.values()).sort((a,b)=> (a.descripcion||"").localeCompare(b.descripcion||""));
    }

    /* ====== COSTOS: fetch en lotes ====== */
    async function cargarCostosParaCodigos(codigos){
      const faltantes = codigos.filter(c => !costCache.has(c));
      if(!faltantes.length) return;
      const chunks = [];
      for(let i=0;i<faltantes.length;i+=10) chunks.push(faltantes.slice(i, i+10)); // 'in' mÃ¡x 10 ids
      for(const batch of chunks){
        const qCost = query(collection(db,"productos"), where(documentId(),'in', batch));
        const snap  = await getDocs(qCost);
        snap.forEach(d=>{
          const data = d.data() || {};
          const costo = Number(data.costoSinImpuesto ?? 0);
          costCache.set(d.id, isFinite(costo) ? costo : 0);
        });
        // si alguno no existe, pon 0 para evitar re-consulta
        batch.forEach(id => { if(!costCache.has(id)) costCache.set(id, 0); });
      }
    }

    /* ====== RENDER ====== */
    function renderCrudo(rows){
      thead.innerHTML = `
        <tr>
          <th>#</th><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Cantidad</th><th>Fecha</th><th>Usuario</th><th>Folio</th>
        </tr>`;
      tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td class="l">${r.codigo||""}</td>
          <td class="l">${r.descripcion||""}</td>
          <td>${fmtDec(r.cantidad,3)}</td>
          <td>${r.fecha||""}</td>
          <td>${r.usuario||""}</td>
          <td class="l">${r.folioSesion||""}</td>
        </tr>`).join("");
      ultimaDescarga = rows;
    }

    function renderAgrupado(rows){
      thead.innerHTML = `
        <tr>
          <th>#</th><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Cantidad Total</th><th>Partidas</th><th>Ãšltima fecha</th>
        </tr>`;
      tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td class="l">${r.codigo}</td>
          <td class="l">${r.descripcion}</td>
          <td>${fmtDec(r.cantidad,3)}</td>
          <td>${r.partidas}</td>
          <td>${r.ultimaFecha}</td>
        </tr>`).join("");
      ultimaDescarga = rows;
    }

    function renderCosteado(rowsAgrupa){
      thead.innerHTML = `
        <tr>
          <th>#</th><th>CÃ³digo</th><th>DescripciÃ³n</th>
          <th>Cantidad</th><th>Costo Unit.</th><th>Total (sin IVA)</th>
        </tr>`;
      let total = 0;
      tbody.innerHTML = rowsAgrupa.map((r,i)=>{
        const cu = Number(costCache.get(r.codigo) ?? 0);
        const tt = cu * Number(r.cantidad || 0);
        total += tt;
        return `
          <tr>
            <td>${i+1}</td>
            <td class="l">${r.codigo}</td>
            <td class="l">${r.descripcion}</td>
            <td>${fmtDec(r.cantidad,3)}</td>
            <td>${fmtMoney(cu)}</td>
            <td>${fmtMoney(tt)}</td>
          </tr>`;
      }).join("");
      kValor.textContent = fmtMoney(total);
      ultimaDescarga = rowsAgrupa.map(r=>({
        ...r,
        costoUnit: Number(costCache.get(r.codigo) ?? 0),
        total: Number((costCache.get(r.codigo) ?? 0)) * Number(r.cantidad || 0),
      }));
    }

    async function render(){
      if(selVista.value === "crudo"){
        renderCrudo(datosCrudos);
      }else if(selVista.value === "agrupado"){
        renderAgrupado(datosAgrupa);
      }else{ // costeado
        // asegÃºrate de tener costos
        const cods = datosAgrupa.map(x=>x.codigo).filter(Boolean);
        setEstado("Cargando costosâ€¦");
        await cargarCostosParaCodigos(cods);
        setEstado("Listo");
        renderCosteado(datosAgrupa);
      }
      // refresca KPIs (incluye valor si hay costos)
      kpisDesdeCrudo(datosCrudos);
    }

    /* ========= CARGA (parche sin Ã­ndices) ========= */
    async function cargar(){
      const suc = selSucursal.value.trim();
      const usr = selUsuario.value.trim();
      if(!suc){ alert("Selecciona una sucursal"); return; }

      setEstado("Cargando escaneosâ€¦");
      limpiarTabla();
      kSucursal.textContent = suc || "â€”";
      kUsuario.textContent  = usr || "Todos";
      costCache = new Map(); // limpia cache al cambiar filtro

      let rows = [];

      if(usr){
        // inventarios/{sucursal}/usuarios/{usuario}/escaneos
        const col = collection(db, "inventarios", suc, "usuarios", usr, "escaneos");
        const snap = await getDocs(col);
        snap.forEach(d=>{
          const r = d.data();
          rows.push({
            codigo: r.codigo || "",
            descripcion: r.descripcion || "",
            cantidad: Number(r.cantidad || 0),
            fecha: r.fecha || "",
            usuario: r.usuario || usr,
            sucursal: suc,
            folioSesion: r.folioSesion || "",
            epochMs: r.epochMs || 0
          });
        });
      }else{
        // fan-out por todos los usuarios definidos
        const lotes = await Promise.all(
          USUARIOS.map(async (u)=>{
            const col = collection(db, "inventarios", suc, "usuarios", u, "escaneos");
            const snap = await getDocs(col);
            const arr = [];
            snap.forEach(d=>{
              const r = d.data();
              arr.push({
                codigo: r.codigo || "",
                descripcion: r.descripcion || "",
                cantidad: Number(r.cantidad || 0),
                fecha: r.fecha || "",
                usuario: r.usuario || u,
                sucursal: suc,
                folioSesion: r.folioSesion || "",
                epochMs: r.epochMs || 0
              });
            });
            return arr;
          })
        );
        rows = lotes.flat();
      }

      // Orden por fecha desc para crudo
      rows.sort((a,b)=> (b.epochMs||0) - (a.epochMs||0));
      datosCrudos = rows;
      datosAgrupa = agruparPorProducto(rows);

      // Si ya estÃ¡ seleccionada la vista costeada, precarga costos de una vez
      if(selVista.value === "costeado"){
        const cods = datosAgrupa.map(x=>x.codigo).filter(Boolean);
        setEstado("Cargando costosâ€¦");
        await cargarCostosParaCodigos(cods);
      }

      setEstado(rows.length ? `Listo: ${rows.length} partidas` : "Sin resultados");
      render();
    }

    // Exportar lo visible a Excel
    btnExportar.addEventListener("click", ()=>{
      if(!ultimaDescarga.length){ alert("Nada que exportar"); return; }
      let ws;
      if(selVista.value === "crudo"){
        const data = [
          ["#", "CÃ³digo", "DescripciÃ³n", "Cantidad", "Fecha", "Usuario", "Folio"]
        ];
        ultimaDescarga.forEach((r,i)=>{
          data.push([i+1, r.codigo, r.descripcion, Number(r.cantidad||0), r.fecha, r.usuario, r.folioSesion]);
        });
        ws = XLSX.utils.aoa_to_sheet(data);

      }else if(selVista.value === "agrupado"){
        const data = [
          ["#", "CÃ³digo", "DescripciÃ³n", "Cantidad Total", "Partidas", "Ãšltima fecha"]
        ];
        ultimaDescarga.forEach((r,i)=>{
          data.push([i+1, r.codigo, r.descripcion, Number(r.cantidad||0), r.partidas, r.ultimaFecha]);
        });
        ws = XLSX.utils.aoa_to_sheet(data);

      }else{ // costeado
        const data = [
          ["#", "CÃ³digo", "DescripciÃ³n", "Cantidad", "Costo Unit. (sin IVA)", "Total (sin IVA)"]
        ];
        ultimaDescarga.forEach((r,i)=>{
          data.push([i+1, r.codigo, r.descripcion, Number(r.cantidad||0), Number(r.costoUnit||0), Number(r.total||0)]);
        });
        ws = XLSX.utils.aoa_to_sheet(data);
      }

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, selVista.value === "costeado" ? "Costeado" : "Inventario");
      const suc = selSucursal.value || "Sucursal";
      const usr = selUsuario.value || "Todos";
      XLSX.writeFile(wb, `Inventario_${selVista.value}_${suc}_${usr}_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    btnCargar.addEventListener("click", cargar);
    selVista.addEventListener("change", render);
  </script>
</body>
</html>
